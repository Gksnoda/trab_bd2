{% extends 'base.html' %} {% load static %} {% load report_extras %} {% load get_item %} {% load humanize %}
 {% block content %} 

<link rel="stylesheet" href="{% static 'reports/css/style.css' %}" />


<div class="container">
  <h1 class="titulo">
  <a href="/reports/builder/" style="text-decoration: none; color: inherit;">
    Twitch Analytics
  </a>
</h1>

  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <form method="get">
        {% csrf_token %}

        <!-- Busca Global -->
        <section class="bloco-filtros">
          <h2 class="titulo-secao">Busca Global</h2>
          <div style="display: flex; gap: 10px">
            {{ form.busca_global }}
            <button type="submit" class="btn" style="margin: 0">Buscar</button>
          </div>
          <div class="quick-filters" style="margin-top: 10px">
            <button type="submit" name="filter" value="top_streamers" class="botao-filtro">Top Streamers</button>
            <button type="submit" name="filter" value="jogos_populares" class="botao-filtro">Jogos Populares</button>
            <button type="submit" name="filter" value="brpt" class="botao-filtro">BR/PT</button>
          </div>
        </section>

        <!-- Seleção de Tabelas -->
        <section class="bloco-filtros">
          <h2 class="titulo-secao">Seleção de Tabelas</h2>
          <div class="campo-select">{{ form.tables }}</div>
        </section>

        <!-- Atributos & Colunas -->
        <section class="bloco-filtros">
          <h2 class="titulo-secao">Atributos e Colunas</h2>
          <div class="columns">
            <div class="botoes-atributos">
              <button type="button" class="btn-secundario" onclick="selecionarTodos()">Selecionar Todos</button>
              <button type="button" class="btn-secundario" onclick="limparSelecao()">Limpar Seleção</button>
            </div>
            <div class="campo-select">{{ form.fields }}</div>
          </div>
        </section>

        <!-- Filtros Avançados -->
        <section class="bloco-filtros">
          <h2 class="titulo-secao">Filtros Avançados</h2>
          <div class="tabs">
      

          <div id="filtro-basico" class="filter-tab">
            <div class="filter-row">
              <div class="campo-filtro">
                <label>Campo</label>
                {{ form.filter_field }}
              </div>
              <div class="campo-filtro">
                <label>Operador</label>
                {{ form.filter_operator }}
              </div>
              <div class="campo-filtro">
                <label>Valor</label>
                {{ form.filter_value }}
              </div>
            </div>
          </div>

        </section>

        <!-- Ordenação -->
        <section class="bloco-filtros">
          <h2 class="titulo-secao">Ordenação</h2>
          <div class="ordenacao-container">
            {{ form.order_field }} {{ form.order_type }}
          </div>
        </section>

        <!-- Preview da Query -->
        <section class="bloco-filtros">
          <h2 class="titulo-secao">Preview da Query</h2>
          <pre class="query-preview">{{ preview_query|default:"-- Selecione ao menos 1 tabela e 1 coluna para exibir o SQL" }}</pre>
        </section>

        <!-- Ações -->
        <section class="bloco-filtros">
          <div class="botoes-centrais">
            <button type="submit" class="btn btn-relatorio">Gerar Relatório</button>
            <button type="reset" class="btn btn-limpar">Limpar Filtros</button>
          </div>
        </section>
      </form>
    </aside>

    <!-- Resultados -->
    <main class="results">
     <section class="metricas">
  <div class="card">
  <strong>{{ total_streamers|intcomma }}</strong><br />Total Streamers
</div>
<div class="card">
  <strong>{{ total_views|floatformat:0|intcomma }}M</strong><br />Total Views
</div>
<div class="card">
  <strong>{{ jogo_mais_popular }}</strong><br />Jogo Mais Popular
</div>
<div class="card">
  <strong>{{ idioma_mais_falado }}</strong><br />Idioma Mais Falado
</div>
<div class="card">
  <strong>
   {% if ultima_atualizacao %}
  {{ ultima_atualizacao }}
{% else %}
  --
{% endif %}
  </strong><br />Última Atualização
</div>

</section>


     <section class="export">
  <a class="export-btn" href="{% url 'export_data' 'excel' %}?{{ request.GET.urlencode }}">Excel</a>
  <a class="export-btn" href="{% url 'export_data' 'csv' %}?{{ request.GET.urlencode }}">CSV</a>
  <a class="export-btn" href="{% url 'export_data' 'json' %}?{{ request.GET.urlencode }}">JSON</a>
  <a class="export-btn" href="{% url 'top_streamers_chart' %}?{{ request.GET.urlencode }}" target="_blank">Gráfico 1</a>
  <a class="export-btn" href="{% url 'top_games_chart' %}?{{ request.GET.urlencode }}" target="_blank">Gráfico 2</a>
</section>


{% load get_item %}

<section class="result-table">
  <table>
    <thead>
      <tr>
        {% if results %}
          {% for key in results.0.keys %}
            <th>
              {{ column_labels|get_item:key|default:key }}
            </th>
          {% endfor %}
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for row in results %}
        <tr>
          {% for key in results.0.keys %}
            <td>{{ row|get_item:key }}</td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
</section>






      <!-- Paginação -->
      {% if results.has_other_pages %}
      <div class="paginacao-numerada">
        {% if results.has_previous %}
          <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}page={{ results.previous_page_number }}" class="botao-paginacao">← Anterior</a>
        {% endif %}

        {% for num in results.paginator.page_range %}
          {% if num > results.number|add:"-5" and num < results.number|add:"5" %}
            {% if num == results.number %}
              <span class="botao-paginacao ativo">{{ num }}</span>
            {% else %}
              <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}page={{ num }}" class="botao-paginacao">{{ num }}</a>
            {% endif %}
          {% endif %}
        {% endfor %}

        {% if results.has_next %}
          <a href="?{% if request.GET %}{{ request.GET.urlencode|safe }}&{% endif %}page={{ results.next_page_number }}" class="botao-paginacao">Próxima →</a>
        {% endif %}
      </div>
      {% endif %}
      <div id="chart-container" style="margin-top: 2rem; text-align:center;"></div>
    </main>
  </div>
</div>




<style>
  .paginacao-numerada {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin-top: 20px;
    flex-wrap: wrap;
  }
  .botao-paginacao {
    padding: 6px 12px;
    border: 1px solid #aaa;
    border-radius: 8px;
    text-decoration: none;
    color: #333;
  }
  .botao-paginacao.ativo {
    background-color: #a855f7;
    color: white;
    font-weight: bold;
    border: 1px solid #a855f7;
  }
</style>

<script>
  function showTab(tabName) {
    document.querySelectorAll(".filter-tab").forEach((tab) => tab.style.display = "none");
    document.getElementById("filtro-" + tabName).style.display = "block";
  }

  function selecionarTodos() {
    document.querySelectorAll('.campo-select input[type="checkbox"]').forEach((cb) => (cb.checked = true));
  }

  function limparSelecao() {
    document.querySelectorAll('.campo-select input[type="checkbox"]').forEach((cb) => (cb.checked = false));
  }

  document.querySelectorAll('input[name="tables"]').forEach((cb) => {
    cb.addEventListener("change", () => {
      document.querySelector("form").submit();
    });
  });

  document.getElementById('show-chart').onclick = function() {
    document.getElementById('chart-container').innerHTML =
      '<img src="{% url "top_streamers_chart" %}?v=' + Date.now() + '" alt="Gráfico" style="max-width:100%;border-radius:12px;box-shadow:0 2px 8px #0002;">';
  };

  document.getElementById('show-chart2').onclick = function() {
    document.getElementById('chart-container').innerHTML =
      '<img src="{% url "top_games_chart" %}?v=' + Date.now() + '" alt="Gráfico 2" style="max-width:100%;border-radius:12px;box-shadow:0 2px 8px #0002;">';
  };
</script>
{% endblock %}
